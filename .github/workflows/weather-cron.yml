name: ğŸŒ¤ï¸ MangoTango Weather Updates
on:
  # Runs every 5 minutes exactly
  schedule:
    - cron: '*/5 * * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: false
        default: 'false'
        type: boolean

# Prevent multiple concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  trigger-weather-notifications:
    name: Send Weather Alerts to Users
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ Start Cron Job
        run: |
          echo "========================================"
          echo "ğŸ•’ MangoTango Weather Cron Started"
          echo "========================================"
          echo "Time: $(date)"
          echo "Trigger: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "========================================"
      
      - name: ğŸ” Load Secrets
        run: |
          echo "Loading cron secrets..."
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ ERROR: CRON_SECRET is not set!"
            echo "Go to: Settings â†’ Secrets â†’ Actions"
            exit 1
          else
            echo "âœ… CRON_SECRET is configured"
          fi
      
      - name: ğŸŒ Call Weather API
        id: call-api
        run: |
          echo "ğŸŒ Calling Vercel API endpoint..."
          
          # Your Vercel endpoint URL
          API_URL="https://mangotango-backend.vercel.app/api/weather-cron"
          
          # Create JSON payload
          JSON_PAYLOAD=$(cat << EOF
          {
            "action": "cron-simulate",
            "secret": "${{ secrets.CRON_SECRET }}",
            "source": "github-actions",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          )
          
          echo "ğŸ“¤ API URL: $API_URL"
          echo "ğŸ“¦ Payload: $JSON_PAYLOAD"
          
          # Make the API call with timeout
          echo "ğŸš€ Sending request..."
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Weather-Cron/1.0" \
            -d "$JSON_PAYLOAD" \
            --max-time 30)
          
          # Extract HTTP status
          http_status=$(echo "$response" | grep HTTP_STATUS: | cut -d: -f2)
          response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
          
          echo "ğŸ“¥ HTTP Status: $http_status"
          echo "ğŸ“„ Response:"
          echo "$response_body" | jq '.' 2>/dev/null || echo "$response_body"
          
          # Save response for next steps
          echo "response_body<<EOF" >> $GITHUB_OUTPUT
          echo "$response_body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "http_status=$http_status" >> $GITHUB_OUTPUT
          
          # Exit if failed
          if [ "$http_status" != "200" ]; then
            echo "âŒ API call failed with status: $http_status"
            exit 1
          fi
          
          echo "âœ… API call successful!"
      
      - name: ğŸ“Š Process Results
        if: success()
        run: |
          echo "========================================"
          echo "ğŸ“Š CRON JOB RESULTS"
          echo "========================================"
          echo "âœ… Weather notifications triggered successfully"
          echo "ğŸ•’ Next run: In 5 minutes"
          echo "ğŸ“ˆ Check Firebase for sent notifications"
          echo "========================================"
      
      - name: ğŸ› Debug Info (On Failure)
        if: failure()
        run: |
          echo "========================================"
          echo "âŒ CRON JOB FAILED"
          echo "========================================"
          echo "Debug information:"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Check if Vercel endpoint is accessible"
          echo "2. Verify CRON_SECRET matches in GitHub and Vercel"
          echo "3. Check Vercel function logs"
          echo "4. Test manually: curl -X POST https://mangotango-backend.vercel.app/api/weather-cron -d '{\"action\":\"cron-simulate\",\"secret\":\"YOUR_SECRET\"}'"
          echo "========================================"
      
      - name: âœ… Final Status
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ Job completed: ${{ job.status }}"
          echo "ğŸ•’ Completion time: $(date)"
          echo "â±ï¸ Duration: ${{ job.container.duration }}"
          echo "ğŸ“‹ Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "========================================"