name: ğŸ•’ Weather Cron Job
on:
  schedule:
    # Runs every 5 minutes
    - cron: '*/5 * * * *'
  # Allows manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log level'
        required: true
        default: 'info'
        type: choice
        options:
          - info
          - debug
      city:
        description: 'Test with specific city'
        required: false
        type: string

jobs:
  trigger-weather-cron:
    name: ğŸŒ¤ï¸ Trigger Weather Updates
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“‹ Start Cron Job
        run: echo "ğŸ•’ Starting weather cron job at $(date)"
        
      - name: ğŸŒ Call Weather API
        id: call-api
        run: |
          echo "ğŸ”— Calling Vercel API endpoint..."
          
          # The API URL - use your Vercel app URL
          API_URL="https://mangotango-backend.vercel.app/api/weather-cron"
          
          # Create the request body
          REQUEST_BODY=$(cat << EOF
          {
            "action": "cron-simulate",
            "secret": "${{ secrets.CRON_SECRET }}"
          }
          EOF
          )
          
          echo "ğŸ“¤ Sending request to: $API_URL"
          
          # Make the API call
          response=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "$REQUEST_BODY")
          
          # Split response body and status code
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | sed '$d')
          
          echo "ğŸ“¥ Response Code: $http_code"
          echo "ğŸ“¦ Response Body:"
          echo "$response_body" | jq '.' 2>/dev/null || echo "$response_body"
          
          # Check if successful
          if [[ "$http_code" == "200" ]]; then
            echo "âœ… Cron job triggered successfully!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to trigger cron job"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: ğŸ“Š Log Results
        if: always()
        run: |
          echo "ğŸ Cron job completed at $(date)"
          echo "ğŸ“Š Job Summary:"
          echo "- Trigger: ${{ github.event_name }}"
          echo "- Repository: ${{ github.repository }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"